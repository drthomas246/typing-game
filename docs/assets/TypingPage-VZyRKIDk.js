const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ResultsDialog-DS7el_oa.js","./chakra-ev5tm03T.js","./react-BgsZg_Iy.js","./index-ZUsRVNrG.js","./howler-BcIsYNvD.js","./framer-BSWg1Rk5.js","./SettingsDrawer-BzRTVXhC.js"])))=>i.map(i=>d[i]);
import{u as v,a as Q,b as F,c as Y,h as B,d as $,e as X,f as Z,A as ee,_ as G}from"./index-ZUsRVNrG.js";import{j as s,h as x,r as c,T as S,R as U,H as k,n as R,I as V,A as te,S as ne,B as O,o as re,p as ae,u as se,q as le,s as oe}from"./chakra-ev5tm03T.js";import{A as N,m as D}from"./framer-BSWg1Rk5.js";import"./react-BgsZg_Iy.js";import"./howler-BcIsYNvD.js";function ie({typed:e,correctMap:n,answer:t,showHint:a}){const l=e.length-1,o=a?t.split(""):e.split("");return s.jsxs(x,{fontFamily:"mono",fontSize:{base:"lg",md:"2xl"},lineHeight:"1.8",wordBreak:"break-word",h:"45px",children:[o.map((i,r)=>{if(!a){if(e.length===0||r>=e.length)return null;if(r===l){const m=n[r]?"blue.solid":"red.solid";return s.jsx(x,{as:"span",color:m,whiteSpace:"pre",children:e[r]},r)}const d=n[r]?"fg":"red.solid";return s.jsx(x,{as:"span",color:d,whiteSpace:"pre",children:e[r]},r)}if(r<e.length){if(r===l){const m=n[r]?"blue.solid":"red.solid";return s.jsx(x,{as:"span",color:m,whiteSpace:"pre",children:e[r]},r)}const d=n[r]?"fg":"red.solid";return s.jsx(x,{as:"span",color:d,whiteSpace:"pre",children:e[r]},r)}else return s.jsx(x,{as:"span",color:"gray.focusRing",whiteSpace:"pre",children:i},r)}),e.length===0&&!a&&s.jsx(x,{as:"span",color:"fg.muted",children:"(こたえのスペルをにゅうりょくしてね)"})]})}function ce({onKey:e,enabled:n=!0,handleEnter:t=!0,handleBackspace:a=!0,handleSpace:l=!0,handleTab:o=!0}){return c.useEffect(()=>{if(!n)return;const i=r=>{if(n){if(o&&r.key==="Tab"){e("	",r),r.preventDefault();return}if(l&&(r.key===" "||r.code==="Space")){e(" ",r),r.preventDefault();return}if(r.key.length===1){e(r.key,r),r.preventDefault();return}if(a&&r.key==="Backspace"){e("\b",r),r.preventDefault();return}if(t&&r.key==="Enter"){e(`
`,r),r.preventDefault();return}}};return window.addEventListener("keydown",i,{capture:!0}),()=>window.removeEventListener("keydown",i,{capture:!0})},[e,n,t,a,l,o]),null}function ue({typed:e,correctMap:n,answer:t,showHint:a,state:l,inputOnKey:o,resultOpen:i,engine:r}){return s.jsxs(s.Fragment,{children:[s.jsxs(x,{p:"4",rounded:"xl",borderWidth:"1px",bg:"bg.panel",h:"109px",children:[s.jsx(ie,{typed:e,correctMap:n,answer:t,showHint:a}),s.jsx(S,{mt:"2",fontSize:"sm",color:"fg.muted",children:"スペースキー: 次のたん語 / エンターキー: はじめる、おわる / バックスペースキー: 1文字消す / タブキー: ヒント"})]}),s.jsx(ce,{enabled:!l.finished&&!i,onKey:(d,m)=>{if(d===`
`){if(m.preventDefault(),!l.started)r.start();else if(!l.finished){r.stop();return}}o(d)}})]})}function W({arenaRef:e,slashId:n,hurtId:t}){const[a,l]=U.useState(400),o=U.useCallback(()=>{const i=e?.current;if(!i||typeof i.getBoundingClientRect!="function")return;const r=i.getBoundingClientRect(),d=Math.hypot(r.width,r.height)/2+60;l(d)},[e]);return c.useLayoutEffect(()=>{const i=requestAnimationFrame(o);return()=>cancelAnimationFrame(i)},[o]),U.useEffect(()=>{const i=e?.current;if(!i||typeof ResizeObserver>"u")return;const r=new ResizeObserver(()=>o());return r.observe(i),()=>r.disconnect()},[e,o]),s.jsxs(s.Fragment,{children:[s.jsx(N,{children:n>0&&s.jsx(x,{position:"absolute",inset:"0",display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",zIndex:10,children:s.jsx(D.div,{style:{width:"160%",height:"12px",borderRadius:"999px",background:"linear-gradient(90deg, rgba(255,0,0,0) 0%, rgba(255,0,0,1) 50%, rgba(255,0,0,0) 100%)",boxShadow:"0 0 8px rgba(255,0,0,0.9), 0 0 16px rgba(255,0,0,0.6)",transformOrigin:"center"},initial:{opacity:0,rotate:-45,x:+a,y:-a},animate:{opacity:[0,1,1,0],rotate:-45,x:-a,y:+a},transition:{duration:.4,ease:"easeOut"},exit:{opacity:0,rotate:-45}},n)})}),s.jsx(N,{children:t>0&&s.jsx(D.div,{style:{position:"absolute",inset:0,background:"rgba(255,0,0,0.35)",pointerEvents:"none",zIndex:15},initial:{opacity:0},animate:{opacity:[0,1,0]},transition:{duration:.6,times:[0,.2,.8,1],ease:"easeOut"},exit:{opacity:0}},`flash-${t}`)})]})}function de({current:e,max:n,pct:t}){return s.jsxs(k,{gap:"3",align:"center",children:[s.jsx(R,{colorPalette:"purple",variant:"solid",children:"てきのHP"}),s.jsx(x,{flex:"1",h:"18px",rounded:"full",bg:"blackAlpha.200",overflow:"hidden",children:s.jsx(x,{h:"full",w:`${t}%`,bg:"purple.500"})}),s.jsxs(S,{w:"96px",textAlign:"right",children:[e,"/",n]})]})}const pe=D.img;function fe({backgroundImg:e,enemyImg:n,vanishId:t,vanished:a,onVanishDone:l}){return s.jsxs(s.Fragment,{children:[s.jsx(V,{src:e,alt:"Background",fit:"cover",w:"100%",h:"100%"}),!a&&s.jsx(pe,{src:n,alt:"Enemy",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"contain"},initial:{opacity:1,scale:1,x:0},animate:{opacity:t>0?[1,1,0]:1,x:t>0?[0,-20,20,-18,18,-15,15,-10,10,-5,5,0]:0,scale:t>0?.95:1},transition:{opacity:{duration:1.2,ease:"easeOut",times:[0,.6,1]},x:{duration:1.2,ease:"easeInOut"},scale:{duration:1.2,ease:"easeOut"}},onAnimationComplete:()=>{t>0&&l()}},`monster-${t}`)]})}function he({questionText:e,questionImg:n}){return s.jsxs(x,{w:"450px",children:[s.jsx(x,{rounded:"lg",borderWidth:"1px",p:"3",bg:"gray.subtle",children:s.jsx(S,{fontSize:{base:"lg",md:"xl"},color:"fg",children:e})}),s.jsx(x,{mt:"16px",children:s.jsx(te,{ratio:1/1,w:"200px",mx:"auto",children:n?s.jsx(V,{src:n,alt:e||"question image",objectFit:"contain",rounded:"lg",borderWidth:"1px",bg:"white",p:"2"}):s.jsx(ne,{rounded:"lg"})})})]})}const me=D.div,xe=c.forwardRef(({enemyImg:e,backgroundImg:n,hurtId:t,vanishId:a,vanished:l,slashId:o,onVanishDone:i,questionText:r,questionImg:d,state:m,enemyHpPct:p,arenaRef:h,outerH:b,arenaH:f,safeNoAnimatePresence:y=!1,safeNoDamageMotion:g=!1},j)=>{const E=b??"calc(100vh - 293px)",u=f??"calc(100vh - 367px)",w=s.jsx(fe,{backgroundImg:n,enemyImg:e,vanishId:a,vanished:l,onVanishDone:i});return s.jsxs(x,{rounded:"xl",borderWidth:"1px",p:"4",bg:"bg.subtle",h:E,children:[s.jsxs(k,{gap:"16px",h:u,mb:"16px",children:[s.jsxs(x,{ref:j,mx:"auto",w:"100%",h:u,rounded:"2xl",borderWidth:"1px",overflow:"hidden",bg:"blackAlpha.50",position:"relative",children:[y?s.jsx(x,{w:"100%",h:"100%",position:"relative",children:w}):s.jsx(N,{initial:!1,mode:"popLayout",children:t>0?s.jsx(me,{style:{width:"100%",height:"100%",position:"relative"},initial:{x:0},animate:{x:[0,-14,14,-10,10,-6,6,0]},transition:{duration:.45,ease:"easeInOut"},exit:{x:0},children:w},`shake-${t}`):s.jsx(x,{w:"100%",h:"100%",position:"relative",children:w})}),!g&&s.jsx(W,{arenaRef:h,slashId:o,hurtId:t})]}),s.jsx(he,{questionText:r,questionImg:d})]}),s.jsx(de,{current:m.enemyHp,max:m.enemyMaxHp,pct:p})]})});function ye({started:e,finished:n,onStart:t,onEscape:a,onOpenSettings:l,onBack:o}){const i=v();return s.jsxs(k,{children:[s.jsx(O,{onClick:o,variant:"outline",children:"もどる"}),s.jsx(O,{onClick:l,variant:"outline",children:"せってい"}),!e||n?s.jsx(O,{colorPalette:"blue",onClick:t,children:i?"始める":"バトル"}):s.jsx(O,{colorPalette:"red",onClick:a,children:i?"終わる":"にげる"})]})}function ge({title:e,start:n,stop:t,state:a,setShouldPlay:l,onOpen:o}){const i=Q(),r=F(),d=()=>{l(!1),n()},m=()=>{t("escape")};return s.jsxs(k,{justify:"space-between",h:"40px",children:[s.jsxs(re,{size:"lg",children:[s.jsx(S,{as:"span",color:"#1E90FF",children:"ことば"}),"の",s.jsx(S,{as:"span",color:"#E60033",fontWeight:"bold",children:"魔王"}),"と",s.jsx(S,{as:"span",color:"#228B22",children:"えいご"}),"の",s.jsx(S,{as:"span",color:"#FFD700",children:"勇者"})," ","～",e,"～"]}),s.jsx(ye,{started:a.started,finished:a.finished,onStart:d,onEscape:m,onOpenSettings:o,onBack:()=>{r&&ae.flushSync(()=>l(!1)),i(0)}})]})}function be({learnThenRecall:e,phase:n}){if(!v())return null;if(e){const a=n==="study";return s.jsxs(k,{h:"24px",children:[s.jsx(R,{colorScheme:a?"blue":"purple",variant:"solid",children:a?"練習（スペル＋音声）":"ふく習（Tabキーでヒント。1回目で音声・2回目でスペル）"}),s.jsx(S,{fontSize:"sm",color:"fg.muted",children:"学習で正かい → ふく習へ ふく習で正かいすると次の問題に進みます。"})]})}return s.jsxs(k,{h:"24px",children:[s.jsx(R,{colorScheme:"blue",variant:"solid",children:"練習（スペル＋音声）"}),s.jsx(S,{fontSize:"sm",color:"fg.muted",children:"学習で正かい → 次の問題に進みます。"})]})}function He({current:e,max:n,pct:t}){const a=Y();return s.jsxs(k,{gap:"3",align:"center",h:"24px",children:[s.jsx(R,{colorPalette:"blue",variant:"solid",children:"あなたのLv"}),s.jsx(S,{w:"2em",textAlign:"left",children:a}),s.jsx(R,{colorPalette:"blue",variant:"solid",children:"あなたのHP"}),s.jsx(x,{flex:"1",h:"18px",rounded:"full",bg:"blackAlpha.200",overflow:"hidden",children:s.jsx(x,{h:"full",w:`${t}%`,bg:"blue.500"})}),s.jsxs(S,{w:"96px",textAlign:"right",children:[e,"/",n]})]})}const q=(e,n,t)=>Math.min(t,Math.max(n,e));function K(e){const n=Math.max(1,e.playerMaxHp??100),t=Math.max(1,e.enemyMaxHp??100),a=!!e.learningMode;return{started:!1,finished:!1,index:0,questionJa:"",answerEn:"",questionImg:void 0,typed:"",correctMap:[],hits:0,errors:0,showHint:a,hintStep:0,learningPhase:"study",problemHasMistake:!1,problemUsedHint:a,playerHp:n,enemyHp:t,playerMaxHp:n,enemyMaxHp:t,combo:0,playCount:0,usedHintCount:0,mistakeProblemCount:0}}function Se(e,n){switch(n.type){case"START":{const{now:t,playerMaxHp:a,enemyMaxHp:l,learning:o,playCount:i}=n.payload;return{...K({playerMaxHp:a,enemyMaxHp:l,learningMode:o}),started:!0,finished:!1,startAt:t,playCount:i,learningPhase:o?"study":"recall",showHint:o,hintStep:0}}case"STOP":return e.finished?e:{...e,finished:!0,victory:n.payload.victory};case"FINISH":return{...e,finished:!0,victory:n.payload.victory};case"LOAD_PAIR":{const{index:t,pair:a,learning:l}=n.payload;return{...e,index:t,questionJa:a.ja,answerEn:a.en,questionImg:a.img,typed:"",correctMap:[],showHint:l,problemHasMistake:!1,problemUsedHint:l,hintStep:0,learningPhase:"study"}}case"TYPE_CHAR":{const t=n.payload.ok;return{...e,typed:e.typed+n.payload.key,correctMap:[...e.correctMap,t],hits:e.hits+(t?1:0),errors:e.errors+(t?0:1),problemHasMistake:e.problemHasMistake||!t}}case"BACKSPACE":return e.typed.length===0?e:{...e,typed:e.typed.slice(0,-1),correctMap:e.correctMap.slice(0,-1)};case"SET_PHASE":{const{phase:t,showHint:a}=n.payload;return{...e,learningPhase:t,showHint:a??t==="study",typed:"",correctMap:[],hintStep:0}}case"SET_HINT_STEP":{const{step:t,showHint:a,markUsedHint:l}=n.payload;return{...e,hintStep:t,showHint:a??e.showHint,problemUsedHint:l?!0:e.problemUsedHint}}case"MARK_USED_HINT":return{...e,problemUsedHint:!0};case"SYNC_LEARNING_TOGGLE":{const{learning:t,learnThenRecall:a}=n.payload,l=t?!a||e.learningPhase==="study":!1,o=e.hintStep===2?!0:l;return{...e,showHint:o,problemUsedHint:e.problemUsedHint||o&&e.hintStep===2}}case"TALLY_QUESTION":{const t=e.problemUsedHint?1:0,a=e.problemHasMistake?1:0,o=e.problemUsedHint||e.problemHasMistake?0:e.combo+1;return{...e,usedHintCount:e.usedHintCount+t,mistakeProblemCount:e.mistakeProblemCount+a,combo:o}}case"DAMAGE_PLAYER":{const t=q(e.playerHp-n.payload.amount,0,e.playerMaxHp),a=t<=0||e.enemyHp<=0;return{...e,playerHp:t,finished:a?!0:e.finished,victory:a&&e.enemyHp>0?!1:e.victory}}case"DAMAGE_ENEMY":{const t=q(e.enemyHp-n.payload.amount,0,e.enemyMaxHp),a=e.playerHp<=0||t<=0;return{...e,enemyHp:t,finished:a?!0:e.finished,victory:a?t<=0&&e.playerHp>0:e.victory}}default:return e}}function we(e,n,t,a,l){const o=v(),i=e.battleMode??!0,r=Math.max(1,e.damagePerMiss??5),d=Math.max(1,e.damagePerSentence??e.damagePerHit??10),m=c.useCallback(h=>{if(t(f=>f+1),!i||o)return;n.sfx.punch();const b=h.playerHp>0&&Math.max(0,h.playerHp-r)===0;l({type:"DAMAGE_PLAYER",payload:{amount:r}}),b&&(n.sfx.fallDown(),n.stopBgm())},[i,r,o,l,t,n]),p=c.useCallback(h=>{if(!i)return;o||n.sfx.slash(),a(f=>f+1);const b=h.enemyHp>0&&Math.max(0,h.enemyHp-d)===0;l({type:"DAMAGE_ENEMY",payload:{amount:d}}),b&&(o||(n.sfx.defeat(),setTimeout(()=>{n.sfx.levelUp()},2500)),n.stopBgm())},[i,d,o,l,a,n]);return{onMiss:m,onSentenceClear:p}}function je(e){const n=v(),{state:t,opts:a,dispatch:l,judgeChar:o,speak:i,onMiss:r,onSentenceClear:d,next:m,sound:p,setPhase:h}=e;return{onKey:c.useCallback(f=>{if(!t.started||t.finished||t.answerEn.length===0)return;if(f===" "){l({type:"TALLY_QUESTION"}),m();return}if(f==="	"){const w=t.learningPhase==="recall";if(!n||w)if(t.hintStep===0){try{i(t.answerEn,{lang:"en-US"})}catch{i(t.answerEn,{lang:"en-US"})}l({type:"SET_HINT_STEP",payload:{step:1,markUsedHint:!0}}),n||r(t)}else t.hintStep===1&&(l({type:"SET_HINT_STEP",payload:{step:2,showHint:!0,markUsedHint:!0}}),n||r(t));return}if(f==="\b"){t.typed.length>0&&l({type:"BACKSPACE"});return}if(f===`
`||t.typed.length>=t.answerEn.length)return;const y=t.typed.length,g=o(t.answerEn,y,f);l({type:"TYPE_CHAR",payload:{key:f,ok:g.ok}}),g.ok||r(t),p.sfx.keyOn();const j=y+1===t.answerEn.length,E=t.correctMap.every(Boolean);if(j&&g.ok&&E){if(n&&a.learnThenRecall&&t.learningPhase==="study"){h("recall");return}d(t),l({type:"TALLY_QUESTION"}),m()}},[p,t,n,a.learnThenRecall,l,o,i,r,d,m,h])}}function Ee(e){const n=v(),{state:t,dispatch:a,opts:l}=e,o=c.useCallback(i=>{const r=!!n,d=!!l.learnThenRecall;a({type:"SET_PHASE",payload:{phase:i,showHint:r?!d||i==="study":!1}})},[a,n,l.learnThenRecall]);return c.useEffect(()=>{!t.started||t.finished||a({type:"SYNC_LEARNING_TOGGLE",payload:{learning:!!n,learnThenRecall:!!l.learnThenRecall}})},[t.started,t.finished,a,n,l.learnThenRecall]),{setPhase:o}}function Me(e){return()=>{e+=1831565813;let n=e;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}function ve(e,n){const t=Me(n);return[...e].sort(()=>t()-.5)}function ke(e,n){const[t,a]=c.useState([]),l=c.useCallback(()=>{const i=n.seed??Date.now()%1e6,r=Array.from({length:e.length},(m,p)=>p),d=n.randomOrder??!0;a(d?ve(r,i):r)},[e.length,n.seed,n.randomOrder]),o=c.useCallback(i=>{const r=t[i]??0;return e[r]??e[0]},[t,e]);return{order:t,initOrder:l,getPair:o}}function Pe(e){const n=F(),t=n,a=e.bgmSrc??"./music/bgm/battle.mp3",l=Math.min(1,Math.max(0,e.bgmVolume??.5)),o=c.useRef(null),i=c.useCallback(()=>{if(!t||o.current?.playing())return;if(o.current){try{o.current.stop(),o.current.unload()}catch{}o.current=null}const y=new B.Howl({src:[a],loop:!0,volume:l,html5:!1});o.current=y,y.play()},[t,a,l]),r=c.useCallback(()=>{if(o.current){try{o.current.stop(),o.current.unload()}catch{}o.current=null}},[]),d=n,m=Math.min(1,Math.max(0,e.sfxVolume??.8)),p=c.useRef({slash:null,punch:null,defeat:null,escape:null,fallDown:null,levelUp:null,keyOn:null}),h={slash:e.sfxSlashSrc??"./music/soundEffects/killInSword.mp3",punch:e.sfxPunchSrc??"./music/soundEffects/punch.mp3",defeat:e.sfxDefeatSrc??"./music/soundEffects/defeat.mp3",escape:e.sfxEscapeSrc??"./music/soundEffects/escape.mp3",fallDown:e.sfxFallDownSrc??"./music/soundEffects/fallDown.mp3",levelUp:e.sfxLevelUpSrc??"./music/soundEffects/lvup.mp3",keyOn:e.sfxKeyOnSrc??"./music/soundEffects/keyon.mp3"},b=(y,g)=>{p.current[y]||(p.current[y]=new B.Howl({src:[g],volume:m,html5:!1}))},f=(y,g)=>{if(d){b(y,g);try{p.current[y]?.play()}catch{}}};return c.useEffect(()=>()=>{r();try{p.current.slash?.unload()}catch{}try{p.current.punch?.unload()}catch{}try{p.current.defeat?.unload()}catch{}try{p.current.escape?.unload()}catch{}try{p.current.fallDown?.unload()}catch{}try{p.current.levelUp?.unload()}catch{}try{p.current.keyOn?.unload()}catch{}p.current={slash:null,punch:null,defeat:null,escape:null,fallDown:null,levelUp:null,keyOn:null}},[r]),{playBgm:i,stopBgm:r,sfx:{slash:()=>f("slash",h.slash),punch:()=>f("punch",h.punch),defeat:()=>f("defeat",h.defeat),escape:()=>f("escape",h.escape),fallDown:()=>f("fallDown",h.fallDown),levelUp:()=>f("levelUp",h.levelUp),keyOn:()=>f("keyOn",h.keyOn)}}}function Ae(e){const n=v(),{state:t,lang:a="en-US"}=e,{speak:l}=$(),o=c.useRef("");c.useEffect(()=>{if(!t.started||t.finished||!n||!t.answerEn||t.learningPhase!=="study")return;const i=`${t.index}:${t.answerEn}`;if(o.current!==i){o.current=i;try{l(t.answerEn,{lang:a})}catch{try{l(t.answerEn,a)}catch{}}}},[t,n,a,l])}function Ce(e,n,t){const[a,l]=c.useState(Date.now());return c.useEffect(()=>{if(!n||t)return;l(Date.now());const o=setInterval(()=>l(Date.now()),e);return()=>clearInterval(o)},[n,t,e]),{nowMs:a}}const z=e=>/[a-z]/i.test(e)?e.toLowerCase():e;function Re(e,n,t){const a=e[n]??"";return t===`
`||t==="\b"?{ok:!1,expected:a,received:t}:{ok:z(a)===z(t),expected:a,received:t}}function Te(e,n,t,a,l,o){const i=v(),[r,d]=c.useReducer(Se,K(e)),m=Math.max(16,e.tickMs??100),p=Pe(e),{order:h,initOrder:b,getPair:f}=ke(n,e),{nowMs:y}=Ce(m,r.started,r.finished),{setPhase:g}=Ee({state:r,dispatch:d,opts:e}),{speak:j}=$(),E=c.useRef(0),u=c.useCallback(()=>{l(0),o(!1),b(),i||p.playBgm(),d({type:"START",payload:{now:Date.now(),playerMaxHp:Math.max(1,e.playerMaxHp??100),enemyMaxHp:Math.max(1,e.enemyMaxHp??100),learning:!!i,playCount:E.current}})},[b,i,e.playerMaxHp,e.enemyMaxHp,l,o,p]),w=c.useRef(!1),_=c.useCallback(H=>{w.current||(d({type:"TALLY_QUESTION"}),w.current=!0),H==="escape"&&!i&&p.sfx.escape(),p.stopBgm();let M=r.victory;(H==="escape"||H==="dead")&&(M=!1),H==="victory"&&(M=!0),d({type:"STOP",payload:{victory:M}}),E.current+=1},[i,p,r.victory]),P=c.useCallback(()=>{const H=r.index+1;if(!(H<h.length)){p.stopBgm(),d({type:"FINISH",payload:{victory:r.enemyHp<=0}});return}const L=f(H);d({type:"LOAD_PAIR",payload:{index:H,pair:L,learning:!!i}})},[r.index,h.length,f,p,r.enemyHp,i]);Ae({state:r,lang:"en-US"});const{onMiss:A,onSentenceClear:T}=we(e,p,a,t,d),{onKey:C}=je({state:r,opts:e,dispatch:d,judgeChar:Re,speak:j,onMiss:A,onSentenceClear:T,next:P,sound:p,setPhase:g});c.useEffect(()=>{if(!r.started||r.finished||r.answerEn!==""||h.length===0)return;const H=f(0);d({type:"LOAD_PAIR",payload:{index:0,pair:H,learning:!!i}})},[r.started,r.finished,r.answerEn,h.length,f,i]);const I=c.useMemo(()=>!r.started||!r.startAt?0:Math.max(0,Math.floor((y-r.startAt)/1e3)),[r.started,r.startAt,y]);return{state:r,start:u,stop:_,next:P,onKey:C,setLearningPhase:g,actualTimeSec:I}}function Oe(e){const{src:n,loop:t=!0,volume:a=.4,enabled:l}=e,[o,i]=c.useState(l),r=c.useRef(null);return c.useEffect(()=>{i(l)},[l]),c.useEffect(()=>{if(o){if(r.current?.playing())return;r.current||(r.current=new B.Howl({src:[n],loop:t,volume:a,html5:!0}));try{r.current.playing()||r.current.play()}catch{}}else if(r.current){try{r.current.stop(),r.current.unload()}catch{}r.current=null}},[o,n,t,a]),{shouldPlay:o,setShouldPlay:i}}function De(){const[e,n]=c.useState(""),[t,a]=c.useState("");return c.useEffect(()=>{const l=["slime","goblin","dragon"],o=l[Math.floor(Math.random()*l.length)];n(`./images/monster/${o}.png`);const i=Math.floor(Math.random()*3);a(`./images/background/${i}.png`)},[]),{enemyImg:e,backgroundImg:t}}const _e=c.lazy(()=>G(()=>import("./ResultsDialog-DS7el_oa.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url).then(e=>({default:e.ResultsDialog}))),Ie=c.lazy(()=>G(()=>import("./SettingsDrawer-BzRTVXhC.js"),__vite__mapDeps([6,1,2,3,4,5]),import.meta.url).then(e=>({default:e.SettingsDrawer})));function qe({QA:e,title:n}){const t=Y(),a=v(),l=X(),[o,i]=c.useState({language:"ja",learnThenRecall:!0}),r=Z(),d=F(),[m,p]=c.useState(0),[h,b]=c.useState(0),[f,y]=c.useState(0),[g,j]=c.useState(!1),E=c.useMemo(()=>10,[]),u=Te({learnThenRecall:o.learnThenRecall,battleMode:!0,playerMaxHp:100+(t-1)*10,enemyMaxHp:E*e.length,damagePerHit:10,damagePerMiss:5,learningMode:a,randomOrder:l},e,p,b,y,j),{enemyImg:w,backgroundImg:_}=De(),{setShouldPlay:P}=Oe({src:"./music/bgm/waitScreen.mp3",loop:!0,volume:.4,enabled:d}),A=se(),[T,C]=c.useState(!1);c.useEffect(()=>{if(u.state.started&&u.state.finished){u.state.enemyHp===0&&y(J=>J+1);const L=setTimeout(()=>C(!0),0);return()=>clearTimeout(L)}},[u.state.started,u.state.finished,u.state.enemyHp]);const I=c.useMemo(()=>Math.round(u.state.enemyHp/u.state.enemyMaxHp*100),[u.state.enemyHp,u.state.enemyMaxHp]),H=c.useMemo(()=>Math.round(u.state.playerHp/u.state.playerMaxHp*100),[u.state.playerHp,u.state.playerMaxHp]),M=c.useRef(null);return s.jsx(s.Fragment,{children:r!==0?s.jsxs(le,{p:"6",maxW:"container.md",children:[s.jsxs(oe,{gap:"6",children:[s.jsx(ge,{title:n,start:u.start,stop:u.stop,state:u.state,setShouldPlay:P,settings:o,onOpen:A.onOpen}),s.jsx(xe,{ref:M,enemyImg:w,backgroundImg:_,hurtId:h,vanishId:f,vanished:g,onVanishDone:()=>j(!0),slashId:m,questionText:u.state.questionJa?u.state.questionJa:a?"問題がここに出るよ":"バトル開始",questionImg:u.state.questionImg,state:u.state,enemyHpPct:I,arenaRef:M,children:s.jsx(W,{arenaRef:M,slashId:m,hurtId:h})}),a&&s.jsx(be,{learnThenRecall:o.learnThenRecall,phase:u.state.learningPhase}),!a&&s.jsx(He,{current:u.state.playerHp,max:u.state.playerMaxHp,pct:H}),s.jsx(ue,{typed:u.state.typed,correctMap:u.state.correctMap,answer:u.state.answerEn,showHint:u.state.showHint,state:u.state,inputOnKey:u.onKey,resultOpen:T,engine:u})]}),s.jsx(c.Suspense,{fallback:s.jsx("div",{children:"Loading..."}),children:s.jsx(Ie,{open:A.open,onClose:A.onClose,settings:o,onChange:i,engine:u})}),s.jsx(c.Suspense,{fallback:s.jsx("div",{children:"Loading..."}),children:s.jsx(_e,{open:T,setOpen:C,onRetry:()=>{C(!1),u.start()},setShouldBgmPlay:P,summary:{timeSec:u.actualTimeSec,usedHintCount:u.state.usedHintCount,mistakeProblemCount:u.state.mistakeProblemCount,killedNow:u.state.enemyHp===0&&a!==!0}})})]}):s.jsx(ee,{played:!1})})}export{qe as TypingPage};
